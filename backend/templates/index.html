<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Quiz</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container" id="quiz-container">
        <!-- Content will be dynamically generated by JavaScript -->
    </div>

    <script>
        const quizContainer = document.getElementById('quiz-container');
        const sessionCode = "{{ session_code }}";
        let ws;
        let myChart;
        let timerInterval;

        function showJoinForm() {
            quizContainer.innerHTML = `
                <h1>Join a Quiz</h1>
                <form onsubmit="joinQuiz(event)">
                    <input type="text" id="code-input" class="input-field" placeholder="Enter 4-Letter Code" maxlength="4" style="text-transform:uppercase" required>
                    <button type="submit" class="button">Join</button>
                </form>
            `;
        }
        
        function showNicknameForm() {
            quizContainer.innerHTML = `
                <h1>Enter Your Nickname</h1>
                <form onsubmit="setNickname(event)">
                    <input type="text" id="nickname-input" class="input-field" placeholder="Your Nickname" required>
                    <button type="submit" class="button">Enter Quiz</button>
                </form>
            `;
        }

        function joinQuiz(event) {
            event.preventDefault();
            const code = document.getElementById('code-input').value.toUpperCase();
            window.location.href = `/join/${code}`;
        }
        
        function setNickname(event) {
            event.preventDefault();
            const nickname = document.getElementById('nickname-input').value;
            connectWebSocket(nickname);
        }

        function connectWebSocket(nickname) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/${sessionCode}`);

            ws.onopen = function() {
                // Send nickname to the server once connected
                ws.send(JSON.stringify({ type: "join", nickname: nickname }));
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                updateUI(data);
            };

            ws.onclose = function() {
                quizContainer.innerHTML = `<h2>Connection lost. Please refresh.</h2>`;
            }
        }

        function updateUI(data) {
            console.log("Received state:", data);
            
            // Clear any existing timer interval
            if (timerInterval) clearInterval(timerInterval);
            
            let html = `
                <div class="status-bar">
                    <div><strong>Code:</strong> ${sessionCode}</div>
                    <div class="audience-count"><strong>Audience:</strong> ${data.audience_count || 1}</div>
                </div>
            `;

            switch(data.state) {
                case "LOBBY":
                    html += `<h2>Waiting for the presenter to start the quiz...</h2>`;
                    break;
                
                case "QUESTION":
                    html += `
                        <div class="timer" id="timer-display"></div>
                        <h2>${data.question}</h2>
                        <div class="options-grid">
                            ${data.options.map(opt => `<button class="option-button" onclick="vote('${opt}')">${opt}</button>`).join('')}
                        </div>
                    `;
                    break;

                case "RESULTS":
                    html += `
                        <h2>Results</h2>
                        <canvas id="results-chart"></canvas>
                        <p>Waiting for the next question...</p>
                    `;
                    // Add leaderboard display
                    if (data.scores) {
                        html += '<h3>Leaderboard</h3><ul class="leaderboard">';
                        // Sort players by score
                        const sortedPlayers = Object.entries(data.scores).sort((a, b) => b[1].score - a[1].score);
                        sortedPlayers.forEach(([name, details]) => {
                             html += `<li>${name}: ${details.score}</li>`;
                        });
                        html += '</ul>';
                    }
                    break;

                case "FINISHED":
                    html += `
                        <h2>Quiz has finished. Thanks for playing!</h2>
                        <div class="final-leaderboard">
                            <h3>Final Rankings</h3>
                            <ul class="leaderboard">
                                ${Object.entries(data.scores || {}).sort((a, b) => b[1].score - a[1].score).map(([name, details]) => `<li>${name}: ${details.score}</li>`).join('')}
                            </ul>
                        </div>
                        <button onclick="window.location.href='/'">üè† Go Home</button>
                    `;
                    break;

                default:
                    html += `<h2>An unknown state occurred.</h2>`;
            }
            quizContainer.innerHTML = html;

            if (data.state === "QUESTION" && data.timer) {
                startCountdown(data.timer);
            }
            if (data.state === "RESULTS") {
                renderChart(data.results, data.correct_answer);
            }
        }
        
        function vote(option) {
            ws.send(JSON.stringify({ type: "vote", option: option }));
            quizContainer.innerHTML = `
                <div class="status-bar">
                    <div><strong>Code:</strong> ${sessionCode}</div>
                </div>
                <h2>Thanks for voting! Waiting for results...</h2>
            `;
        }
        
        function startCountdown(seconds) {
            const timerDisplay = document.getElementById('timer-display');
            let timeLeft = seconds;

            function updateTimer() {
                if (timerDisplay) {
                    timerDisplay.textContent = `Time left: ${timeLeft}s`;
                }
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                }
                timeLeft--;
            }

            updateTimer(); // Initial call
            timerInterval = setInterval(updateTimer, 1000);
        }

        function renderChart(results, correctAnswer) {
            const ctx = document.getElementById('results-chart').getContext('2d');
            if (myChart) {
                myChart.destroy();
            }
            const labels = Object.keys(results);
            const data = Object.values(results);
            
            const backgroundColors = labels.map(label => {
                return label === correctAnswer 
                    ? 'rgba(75, 192, 192, 0.7)' // Correct answer color
                    : 'rgba(255, 99, 132, 0.5)'; // Incorrect answer color
            });
            const borderColors = labels.map(label => {
                return label === correctAnswer
                    ? 'rgba(75, 192, 192, 1)'
                    : 'rgba(255, 99, 132, 1)';
            });

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '# of Votes',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Initial Load
        if (sessionCode) {
            showNicknameForm();
        } else {
            showJoinForm();
        }
    </script>
</body>
</html>